<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Force desktop-like layout also on mobile -->
  <meta name="viewport" content="width=1000">
  <title>AQUAM INSULA Maritime Lifestyle</title>

  <!-- Favicon (place favicon.ico in the same folder as this index.html) -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- fuzzysort (search) -->
  <script src="https://cdn.jsdelivr.net/npm/fuzzysort@2.0.4/fuzzysort.min.js"></script>

  <style>
/* General Styles */
* { outline: none; caret-color: transparent; }
input, textarea { outline: auto; caret-color: auto; }

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  margin: 0;
  padding: 0;
}

.container { padding: 0; max-width: 100%; }

/* Basket sidebar */
#basket-sidebar {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 10px;
  right: 10px;
  width: 110px;
  height: auto;
  background-color: white;
  z-index: 9999;
  border: none;
  box-shadow: none;
}
#basket-sidebar.expanded {
  width: 400px;
  padding: 20px;
  box-shadow: 0px 4px 12px rgba(0, 102, 204, 1);
}
#basket-icon { width: 43px; height: auto; }
#basket-total { font-size: 1.0rem; margin-top: 5px; }
#basket-sidebar #close-basket {
  font-size: 3rem;
  z-index: 10000;
  color: #333;
  cursor: pointer;
  position: absolute;
  top: 10px;
  right: 10px;
  display: none;
}
#basket-content {
  display: none;
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 10px;
}
.basket-has-items {
  box-shadow: 0px 4px 12px rgba(0, 102, 204, 1);
}
.basket-item {
  font-size: 1.0rem;
  margin-bottom: 15px;
  border-bottom: 1px solid #ddd;
  padding-bottom: 10px;
}

/* Add to Basket button */
.btn-add-to-basket {
  background-color: #4a4a4a;
  color: #fff;
  border: none;
  font-size: 1.0rem;
  padding: 5px 10px;
  height: auto;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: auto;
  transition: background-color .2s;
}
.btn-add-to-basket:hover {
  background-color: green;
}

/* Variant styling */
.variant-table {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  justify-content: center;
  flex-wrap: wrap;
}
.variant-option {
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  user-select: none;
  transition: background-color .2s;
}
.variant-option.selected {
  background-color: lightgrey;
}
.variant-option:hover {
  background-color: #e0e0e0;
}

.basket-controls {
  display: flex;
  align-items: center;
  gap: 5px;
}
.quantity-field {
  width: 50px;
  height: 35px;
  text-align: center;
}
.basket-controls .btn-danger,
.basket-controls .btn-success {
  background-color: #4a4a4a;
  color: #fff;
  border: none;
  height: 35px;
  width: 35px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Supercategory & Subcategory */
.supercategory,
.subcategory {
  cursor: pointer;
  text-align: center;
  transition: all .3s ease-in-out;
}
.supercategory img {
  width: 100%;
  height: auto;
}
.supercategory-selected,
.subcategory-selected {
  box-shadow: 0px 4px 12px rgba(0,102,204,1);
}
.supercategory:hover,
.subcategory:hover {
  box-shadow: 0px 4px 12px rgba(100,100,100,.7);
}
.subcategory {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px;
  width: 300px;
  height: 400px;
  box-sizing: border-box;
  text-align: center;
}
.subcategory .card-body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}
.card-img-top {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 5px;
}

/* Spacing between grids */
#subcategory-grid { margin-bottom: 40px; }
#product-grid      { margin-top: 40px; }

#subcategory-grid-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  align-items: center;
}

/* Card Styles */
.grid-item { width: 300px; }
.card {
  width: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  transition: transform .2s ease;
  transform-origin: top left;
}
.card-body {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  width: 100%;
  height: 100%;
}
.card-img-top { object-fit: cover; }
.product-price { font-size: 1.0rem; }
.image-container {
  width: 300px;
  height: 300px;
  overflow: hidden;
}
.card-image {
  max-width: 100%;
  max-height: 300px;
  object-fit: contain;
}

#product-grid-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
  gap: 10px;
}

/* Fonts */
.card-title { font-size: 1.0rem; }
.supercategory h3 {
  font-size: 1.2rem;
  font-weight: normal;
  margin-top: 10px;
}

#quote-form input[type="text"],
#quote-form input[type="email"] {
  font-size: 1.0rem;
  padding: 10px;
  width: 100%;
  box-sizing: border-box;
  margin-top: 10px;
}
#request-quote {
  background-color: rgba(0,102,204,1);
  color: #fff;
  border: none;
  font-size: 1.0rem;
  padding: 10px 12px;
  width: 100%;
}
#request-quote:disabled {
  background-color: #6ca0dc;
  color: #fff;
  cursor: not-allowed;
}

.search-active { background-color: white !important; }

#title-img {
  width: 400px;
  height: auto;
}

/* Search container */
#search-container {
  display: none;
  height: 80px;
  position: absolute;
  top: 10px;
  left: 450px;
  margin-left: 50px;
  align-items: flex-start;
  flex-direction: column;
  z-index: 9999;
}
.input-row {
  display: flex;
  align-items: center;
  width: 100%;
  position: relative;
}

.product-meta { font-size: .95rem; color: #666; }
.detail-material { font-size: 0.95rem; margin-bottom: 0.5rem; }

#search-result-count {
  font-size: 1.0rem;
  margin-top: 5px;
  margin-bottom: 20px;
  align-self: flex-start;
}
#search-input {
  display: block;
  padding: 5px;
  box-sizing: border-box;
  margin: 0;
}
#close-search {
  display: none;
  font-size: 2rem;
  cursor: pointer;
  margin-left: 10px;
  position: absolute;
  right: 0;
}

.hidden {
  opacity: 0;
  visibility: hidden;
  transition: opacity .3s ease, visibility .3s ease;
}

#menu-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 160px;
  z-index: 9999;
  transition: opacity .3s ease, visibility .3s ease;
  background-color: white;
}

#up-icon {
  position: fixed;
  bottom: 10px;
  right: 10px;
  z-index: 9999;
  border-radius: 5px;
  background-color: rgba(255,255,255,.8);
  padding: 5px;
}

#supercategories-container {
  margin-top: 180px;
  opacity: 0;
  transition: opacity .5s ease-in-out;
}
#supercategories-container.show {
  opacity: 1;
}

/* Pagination */
#pagination-controls {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  gap: 10px;
}
#pagination-controls .page-number {
  padding: 5px 10px;
  cursor: pointer;
  border: 1px solid #ddd;
  background-color: #f9f9f9;
}
#pagination-controls .page-number.active {
  font-weight: bold;
  background-color: #ddd;
}
#pagination-controls .page-number:hover {
  background-color: #eee;
}
#pagination-controls span {
  font-size: 1.5rem;
  cursor: pointer;
}

.contact-info {
  font-size: 1.0rem;
  margin: 20px 0;
  text-align: center;
  position: relative;
  z-index: 10;
}

#loading-spinner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
}

/* Mobile: keep mostly desktop-like by viewport width=1000, so we just scale fonts a bit */
@media (max-width: 1024px) {
  body, h1, h2, h3, h4, h5, h6, p, span, a, button, input,
  .card-title, .product-price, .basket-item, .quantity-field, .basket-total-text {
    font-size: 1.1rem !important;
  }
}

/* Equal-height cards in grid */
#product-grid-row { align-items: stretch !important; }
#product-grid-row .grid-item {
  display: flex !important;
}
#product-grid-row .grid-item .card {
  flex: 1 1 auto !important;
  display: flex !important;
  flex-direction: column !important;
}
#product-grid-row .grid-item .card .card-body {
  flex: 1 1 auto !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between;
}
  </style>
</head>
<body>

<div id="menu-container">
  <img id="title-img"
       src="https://raw.githubusercontent.com/toralf-dittmann/aqiml/468d8135b8b830cfcfc753be0fe270cbdcdd01f1/AQUAM%20INSULA%20Maritime%20Lifestyle%20160%20x%2040.jpg"
       alt="AQUAM INSULA Maritime Lifestyle">

  <div id="search-container">
    <div class="input-row">
      <input type="text" id="search-input" placeholder="Search" oninput="executeSearch()">
      <span id="close-search" onclick="clearSearch()" title="exit search">&times;</span>
    </div>
    <div id="search-result-count">0 results</div>
  </div>

  <div id="basket-sidebar">
    <div id="close-basket" class="close-basket" onclick="toggleBasket()">×</div>
    <div id="basket-toggle" style="cursor: pointer;">
      <img id="basket-icon"
           src="https://github.com/toralf-dittmann/aqiml/blob/main/Shopping%20Bag.png?raw=true"
           alt="Basket" width="8">
      <span id="basket-count" style="margin-top:8px; margin-left:3px;">0</span>
    </div>
    <div id="basket-total" style="margin-top: 5px;">$0.00</div>
    <div id="basket-content">
      <h2>Basket</h2>
      <ul id="basket-list" class="list-unstyled"></ul>
      <div id="basket-summary">
        <p id="total-vep">Total VEP: 0.00</p>
        <p id="vat">VAT (15%): 0.00</p>
        <p id="total-vip">Total VIP: 0.00</p>
      </div>

      <!-- Customer Info and Request Quote Button -->
      <div id="quote-form" style="margin-top: 20px;">
        <input type="text" id="customer-name" class="form-control my-2" placeholder="Name">
        <input type="email" id="customer-email" class="form-control my-2" placeholder="E-Mail">
        <button id="request-quote" class="btn btn-primary my-2">Request Quote</button>
      </div>
    </div>
  </div>

  <!-- Contact Information -->
  <div class="contact-info">
    Contact:
    <a href="mailto:maritime-lifestyle@aquam-insula.com"
       style="color: inherit; text-decoration: underline;">
      maritime-lifestyle@aquam-insula.com
    </a>
  </div>
</div>

<!-- Supercategory Table -->
<div id="supercategories-container" style="display: none;">
  <div class="row">
    <div class="col-12 col-md-6 supercategory" id="marine-chandlery-header">
      <img src="https://github.com/toralf-dittmann/aqiml/blob/main/Marine%20Chandlery.jpg?raw=true"
           alt="Marine Chandlery">
      <h3>Marine Chandlery</h3>
    </div>
    <div class="col-12 col-md-6 supercategory" id="maritime-lifestyle-header">
      <img src="https://github.com/toralf-dittmann/aqiml/blob/main/Fashion.jpg?raw=true"
           alt="Maritime Lifestyle">
      <h3>Maritime Lifestyle</h3>
    </div>
  </div>
</div>

<div id="loading-spinner" style="display: block; text-align: center; margin-top: 20px;">
  <div class="spinner-border" role="status" aria-hidden="true"></div>
  <p>... loading App</p>
</div>

<!-- Subcategory Grid -->
<div id="subcategory-grid" class="container" style="display: none;">
  <div class="row" id="subcategory-grid-row"></div>
</div>

<!-- Product Grid -->
<div id="product-grid" class="container" style="display: none;">
  <div class="row" id="product-grid-row"></div>
</div>

<div id="up-icon">
  <img src="https://github.com/toralf-dittmann/aqiml/blob/main/up-round.png?raw=true"
       alt="up Icon" width="40">
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ======= CONFIG: GAS URL =======
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxoShkKUX43wnp2wNJk6diSAUsD-dRzsikEinq0xFR2Wpepg9oTNNOyxNSwG5MKFr3aGg/exec';

  // ======= UTILS =======
  function s(v){ return v==null ? "" : String(v).trim(); }
  function n(v){ return (typeof v==="number") ? v : parseFloat(String(v).replace(/[^\d.-]/g,"")) || 0; }

  function toDriveImg(urlOrId){
    const str = String(urlOrId||"");
    const m = str.match(/[-\w]{25,}/);
    return m ? ("https://drive.google.com/thumbnail?id="+m[0]+"&sz=w1200") : str;
  }

  function getStartParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get('start') || '';
  }

  // Simple GET JSON helper
  async function getJsonOrError(url){
    const res = await fetch(url, { method: 'GET' });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.error){
      throw new Error(data.error || res.statusText || 'GET failed');
    }
    return data;
  }

  // Simple POST (form-encoded) JSON helper: params is an object of simple strings
  async function postFormOrError(url, params){
    const body = new URLSearchParams();
    Object.keys(params || {}).forEach(k => body.append(k, params[k]));
    const res = await fetch(url, {
      method: 'POST',
      body
      // no custom headers so this stays a "simple" CORS request
    });
    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch(e) {}
    if(!res.ok || data.error){
      throw new Error(data.error || res.statusText || 'POST failed');
    }
    return data;
  }

  // ======= GLOBAL STATE =======
  const menuContainer = document.getElementById('menu-container');
  let lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollThreshold = 5;

  let vatRate = 0.15;
  let vatNotice = '';

  let currentSupercategory = '';
  let currentSubcategory   = '';
  let basket               = [];
  let products             = [];
  let productsByGroupKey   = {};
  let searchResults        = [];
  let fuzzyOptions         = null;
  let resultsPerPage       = 100;
  let currentPage          = 1;
  let itemCount            = 0;

  const aiCache = new Map();
  const FALLBACK_TEXT = 'Detailed information currently unavailable. Please try again later.';

  // ======= UI HELPERS =======
  document.addEventListener("mousedown", function(event) {
    if (event.target.tagName !== "INPUT" && event.target.tagName !== "TEXTAREA") {
      document.activeElement.blur();
    }
  });

  function showMenuContainer(){
    menuContainer.classList.remove('hidden');
    const items = menuContainer.querySelectorAll(':scope > *');
    items.forEach(item => {
      item.style.opacity = '1';
      item.style.visibility = 'visible';
    });
  }

  function formatPrice(amount){
    return n(amount).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function normalizeProducts(productsData){
    return (productsData||[])
      .filter(p => !s(p.productNumber).startsWith('X'))
      .map(p => ({
        ...p,
        productNumber:   s(p.productNumber),
        description:     s(p.description),
        variant:         s(p.variant),
        material:        s(p.material),
        sheetName:       s(p.sheetName),
        imageUrl:        s(p.imageUrl),
        storageLocation: s(p.storageLocation),
        imageHash:       s(p.imageHash),
        price:           n(p.price),
        superCategory:   s(p.superCategory),
        subCategory:     s(p.subCategory)
      }));
  }

  function initializeFuzzysort(productsData){
    fuzzyOptions = {
      keys: ['productNumber','description','sheetName','superCategory','subCategory','material'],
      allowTypo: true,
      limit: 100000,
      threshold: -Infinity
    };
    console.log("fuzzysort ready with", productsData.length, "products");
  }

  function groupProducts(){
    productsByGroupKey = {};
    products.forEach(p => {
      const hashKey = s(p.imageHash) || 'no-hash';
      const descKey = s(p.description);
      const key = `${hashKey}|${descKey}`;
      if(!productsByGroupKey[key]) productsByGroupKey[key] = [];
      productsByGroupKey[key].push(p);
    });
  }

  function isSafariBrowser(){
    return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  }
  function scrollToElement(elementId){
    const element = document.getElementById(elementId);
    const yOffset = -80;
    const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;
    window.scrollTo({ top:y, behavior:'smooth' });
  }

  function canonicalizeImageUrl(url){
    try{
      const u = new URL(url);
      return u.origin + u.pathname;
    }catch(e){
      return url.split('?')[0];
    }
  }

  // ======= SUPER / SUB CATEGORIES =======
  function displaySupercategories(){
    document.getElementById('marine-chandlery-header').addEventListener('click', ()=>{
      selectSupercategory('Marine Chandlery','marine-chandlery-header','maritime-lifestyle-header');
    });
    document.getElementById('maritime-lifestyle-header').addEventListener('click', ()=>{
      selectSupercategory('Maritime Lifestyle','maritime-lifestyle-header','marine-chandlery-header');
    });
  }

  function selectSupercategory(supercategory, selectedId, otherId){
    currentSupercategory = supercategory;
    currentSubcategory   = '';

    document.getElementById(selectedId).classList.add('supercategory-selected');
    document.getElementById(otherId).classList.remove('supercategory-selected');

    const searchContainer   = document.getElementById('search-container');
    const searchInput       = document.getElementById('search-input');
    const searchResultCount = document.getElementById('search-result-count');
    const closeSearchButton = document.getElementById('close-search');

    searchContainer.style.display = 'flex';

    searchInput.style.display       = 'block';
    searchResultCount.style.display = 'none';
    closeSearchButton.style.display = 'none';

    searchInput.value = '';
    searchResultCount.textContent = '0 results';

    displaySubcategories(supercategory);
  }

  function displaySubcategories(superCategory){
    const subcategories = products
      .filter(p => p.superCategory === superCategory)
      .map(p => p.subCategory);

    const uniqueSubcategories = [...new Set(subcategories)];
    const subcategoryGridRow  = document.getElementById('subcategory-grid-row');
    subcategoryGridRow.innerHTML = '';

    uniqueSubcategories.forEach(subcategory=>{
      const firstProduct = products.find(p => p.subCategory===subcategory && p.superCategory===superCategory);

      const subcategoryCard = document.createElement('div');
      subcategoryCard.classList.add('col-12','col-md-4','grid-item','subcategory');

      const card = document.createElement('div');
      card.className = 'card subcategory';

      const img = document.createElement('img');
      img.className = 'card-image';
      img.alt = subcategory;
      img.src = toDriveImg(firstProduct ? firstProduct.imageUrl : '');
      card.appendChild(img);

      const body = document.createElement('div');
      body.className = 'card-body';
      const h4 = document.createElement('h4');
      h4.className = 'card-title';
      h4.textContent = subcategory;
      body.appendChild(h4);

      card.appendChild(body);
      subcategoryCard.appendChild(card);

      subcategoryCard.addEventListener('click', function(){
        document.querySelectorAll('.subcategory').forEach(c => c.classList.remove('subcategory-selected'));
        subcategoryCard.classList.add('subcategory-selected');
        currentSubcategory = subcategory;
        loadProducts(subcategory);
        if (isSafariBrowser()){
          scrollToElement('product-grid');
        } else {
          document.getElementById('product-grid')
            .scrollIntoView({behavior:'smooth', block:'start', inline:'nearest'});
        }
      });

      subcategoryGridRow.appendChild(subcategoryCard);
    });

    document.getElementById('subcategory-grid').style.display = 'block';
    document.getElementById('product-grid').style.display     = 'none';
  }

  // ======= SEARCH =======
  function updateSearchResultsCount(count){
    document.getElementById('search-result-count').textContent = `${count} results`;
  }

  function executeSearch(){
    const searchInput       = document.getElementById('search-input');
    const closeSearchButton = document.getElementById('close-search');
    const searchResultCount = document.getElementById('search-result-count');
    const query             = s(searchInput.value).toLowerCase();

    if (query){
      closeSearchButton.style.display  = 'block';
      searchResultCount.style.display  = 'block';
    } else {
      closeSearchButton.style.display  = 'none';
      searchResultCount.style.display  = 'none';
    }
    if (!query) return;

    const base = products.filter(p =>
      p.superCategory === currentSupercategory &&
      (currentSubcategory ? p.subCategory === currentSubcategory : true)
    );

    const results = fuzzysort.go(query, base, fuzzyOptions);
    searchResults = results.map(r => r.obj);

    currentPage = 1;
    updateSearchResultsCount(searchResults.length);
    displayCurrentPage();
  }

  function clearSearch(){
    const searchInput       = document.getElementById('search-input');
    const searchResultCount = document.getElementById('search-result-count');

    searchInput.value = '';
    document.getElementById('close-search').style.display = 'none';
    searchResultCount.style.display = 'none';
    document.getElementById('search-container').classList.remove('search-active');

    const productGridRow    = document.getElementById('product-grid-row');
    const paginationContainer = document.getElementById('pagination-controls');
    productGridRow.innerHTML = '';
    if (paginationContainer){ paginationContainer.innerHTML = ''; }

    searchResults = [];
    currentPage   = 1;
    searchResultCount.textContent = '0 results';

    displaySubcategories(currentSupercategory);
  }

  // ======= PRODUCT GRID & MODAL =======
  function loadProducts(subcategory){
    const filteredProducts = products.filter(p => p.subCategory === subcategory);
    searchResults = filteredProducts;
    currentPage   = 1;
    displayCurrentPage();
    updatePaginationControls();
  }

  function displayCurrentPage(){
    const groupKeys = [];
    const seenKeys  = new Set();
    searchResults.forEach(item=>{
      const hashKey = s(item.imageHash) || 'no-hash';
      const descKey = s(item.description);
      const key = `${hashKey}|${descKey}`;
      if(!seenKeys.has(key)){
        groupKeys.push(key);
        seenKeys.add(key);
      }
    });

    const start    = (currentPage - 1) * resultsPerPage;
    const pageKeys = groupKeys.slice(start, start + resultsPerPage);

    const grid = document.getElementById('product-grid-row');
    grid.innerHTML = '';

    pageKeys.forEach(key=>{
      const group = productsByGroupKey[key] || [];
      if(!group.length) return;
      const first = group[0];

      const cardCol = document.createElement('div');
      cardCol.className = 'col-6 col-md-4 col-lg-2 grid-item';

      const card = document.createElement('div');
      card.className = 'card product-card';
      card.style.cursor = 'pointer';
      card.onclick = () => openProductDetail(key);
      card.dataset.selectedPn = s(first.productNumber);

      const img = document.createElement('img');
      img.className = 'card-image';
      img.alt = s(first.description);
      img.src = toDriveImg(first.imageUrl);
      card.appendChild(img);

      const body = document.createElement('div');
      body.className = 'card-body text-center';

      const h4 = document.createElement('h4');
      h4.className = 'card-title';
      h4.textContent = s(first.description);
      body.appendChild(h4);

      const meta = document.createElement('p');
      meta.className = 'product-meta text-muted';
      meta.style.marginBottom = '6px';
      meta.textContent = [s(first.variant), s(first.material)].filter(Boolean).join(' · ');
      body.appendChild(meta);

      const pnP = document.createElement('p');
      pnP.className = 'product-number';
      body.appendChild(pnP);

      const priceP = document.createElement('p');
      priceP.className = 'product-price';
      const strong = document.createElement('strong');
      priceP.appendChild(strong);
      body.appendChild(priceP);

      card.appendChild(body);
      cardCol.appendChild(card);
      grid.appendChild(cardCol);

      const pnEl    = pnP;
      const priceEl = strong;

      function updateMeta(pn, price){
        const item = group.find(p => s(p.productNumber) === s(pn)) || first;
        const loc  = s(item.storageLocation);
        const pnS  = s(pn);

        pnEl.textContent = /^[JS]/.test(pnS) ? `${pnS} - ${loc}` : pnS;
        priceEl.textContent = `FJD VIP ${formatPrice(n(price) * (1 + vatRate))}`;
        card.dataset.selectedPn = pnS;

        const v   = s(item.variant);
        const mat = s(item.material);
        meta.textContent = [v, mat].filter(Boolean).join(' · ');
      }

      updateMeta(first.productNumber, first.price);

      const weightSum = group.reduce((sum,p)=>{
        const len = s(p.variant).length;
        return sum + (len===1 ? 2 : len===2 ? 1.5 : len);
      },0);

      if (group.length <= 1){
        // single variant: nothing extra
      } else if (weightSum > 20){
        const select = document.createElement('select');
        select.className = 'form-select mt-2 variant-dropdown';
        group.forEach((p,i)=>{
          const opt = new Option(s(p.variant), s(p.productNumber));
          opt.dataset.price = n(p.price);
          if(i===0) opt.selected = true;
          select.append(opt);
        });
        select.addEventListener('click', e=>e.stopPropagation());
        select.addEventListener('change', ()=>{
          const sel = select.selectedOptions[0];
          updateMeta(sel.value, n(sel.dataset.price));
        });
        body.appendChild(select);
      } else if (weightSum > 12){
        let cum = 0;
        const firstRow = [];
        const secondRow = [];
        group.forEach(p=>{
          const len = s(p.variant).length;
          const w   = (len===1 ? 2 : len===2 ? 1.5 : len);
          if (cum + w <= 12 || firstRow.length===0){ firstRow.push(p); cum += w; }
          else { secondRow.push(p); }
        });
        [firstRow, secondRow].forEach((row,rowIdx)=>{
          const wrap = document.createElement('div');
          wrap.className = 'variant-table';
          row.forEach((p,i)=>{
            const cell = document.createElement('div');
            cell.className = 'variant-option' + (rowIdx===0 && i===0 ? ' selected' : '');
            cell.textContent = s(p.variant);
            cell.dataset.price = n(p.price);
            cell.dataset.productNumber = s(p.productNumber);
            cell.addEventListener('click', e=>{
              e.stopPropagation();
              body.querySelectorAll('.variant-option').forEach(x=>x.classList.remove('selected'));
              cell.classList.add('selected');
              updateMeta(cell.dataset.productNumber, n(cell.dataset.price));
            });
            wrap.appendChild(cell);
          });
          body.appendChild(wrap);
        });
      } else {
        const wrap = document.createElement('div');
        wrap.className = 'variant-table';
        group.forEach((p,i)=>{
          const cell = document.createElement('div');
          cell.className = 'variant-option' + (i===0 ? ' selected' : '');
          cell.textContent = s(p.variant);
          cell.dataset.price = n(p.price);
          cell.dataset.productNumber = s(p.productNumber);
          cell.addEventListener('click', e=>{
            e.stopPropagation();
            wrap.querySelectorAll('.variant-option').forEach(x=>x.classList.remove('selected'));
            cell.classList.add('selected');
            updateMeta(cell.dataset.productNumber, n(cell.dataset.price));
          });
          wrap.appendChild(cell);
        });
        body.appendChild(wrap);
      }

      const btn = document.createElement('button');
      btn.className = 'btn-add-to-basket mt-2';
      btn.textContent = 'Add to Basket';
      btn.onclick = e=>{
        e.stopPropagation();
        addToBasket(card.dataset.selectedPn);
      };
      body.appendChild(btn);
    });

    document.getElementById('product-grid').style.display     = 'block';
    document.getElementById('subcategory-grid').style.display = 'none';

    updatePaginationControls();
  }

  function updatePaginationControls(){
    let container = document.getElementById('pagination-controls');
    if(!container){
      container = document.createElement('div');
      container.id = 'pagination-controls';
      document.getElementById('product-grid').appendChild(container);
    }
    container.innerHTML = '';

    const groupKeys = [];
    searchResults.forEach(item=>{
      const imgKey = canonicalizeImageUrl(s(item.imageUrl));
      const key = `${s(item.description)}|${imgKey}`;
      if(!groupKeys.includes(key)) groupKeys.push(key);
    });

    const totalPages = Math.ceil(groupKeys.length / resultsPerPage);
    if (totalPages <= 1) return;

    const left =
